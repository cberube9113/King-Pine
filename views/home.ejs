<% include header %>

<script src="/socket.io/socket.io.js"></script>

<div class="row">
  <div class="span12">
    <% include navbar %>
    <div class="row">
      <div class="span3">
        <div class="small-box">
          <h3>About Me</h3>
          <span class="identifier">Name: </span><%= name %><br>
          <span class="identifier">Email: </span><%= email %><br>
        </div><br />
        <div class="small-box">
          <h3>Trends</h3><br>
        </div><br />
        <div class="small-box">
          <h3>People to Follow</h3><br>
        </div><br />
      </div>
      <div class="span9">

        <div id="svg-div" style="position:absolute;left:0;top:0;width:100%;height:100%;z-index:10;background-color:rgba(0,0,0,0.8);display:none;">
        </div>
     
        <div class="control-group">
          <label for="chirp" class="control-label">Chirp Something:</label>
          <div class="controls">
            <input type="text" name="chirp" id="chirp_box">
          </div>
        </div>
      
        <div class="control-group">
          <div class="controls">
            <input type="button" value="Submit" class="btn btn-primary" id="chirp_submit_btn">
          </div>
        </div>

        <h3>Chirps</h3>
        <div id="chirp_view">
          <% for(var i = 0; i < chirps.length; i++) { %>
            <br /><span><span class="identifier"><%= chirps[i].name %></span> <a href="/<%= chirps[i].username %>">@<%= chirps[i].username %></a> <%= new Date(chirps[i].timestamp).toString().slice(0, -18) %></span>
            <div class="chirper">
              <p><%= chirps[i].data %></p>
            </div>
          <% } %>
        </div>
       
      </div>
    </div>
  </div>
</div>

<script type="text/javascript">
  var socket = io.connect('http://localhost');

// ## sendChirp
// Submits the text in the 'chirp_box' textarea to the other sockets
  function sendChirp() {
  // Retrieve the text in the textarea
    var chirpData = $("#chirp_box").val();
    var d = new Date();
    
    // Send the chirp data to the server
    // First argument is the name given to the emit. The server-side routes/chirp-socket.js responds to emits with this name within 'init'.
    // Second argument is an object containing the chirp text, its timestamp, and the userid of the user who chirped. This is passed to the callback in 'init'.

    if (chirpData.length > 0) {
      socket.emit('chirp', { chirp: chirpData, timestamp: d.getTime(), userid: <%= userid %>, username: '<%= username %>', name: '<%= name %>'});
    } else {
      alert("You must provide content for your chirp!");
    }

	 // Clear the textarea now that the chirp has been submitted.
    $("#chirp_box").val("");
  }
  
  // Send a chirp (by calling sendChirp) when the submit button is clicked.
  $("#chirp_submit_btn").click(function() {
    sendChirp();
  });
  
  // Send a chirp (by calling sendChirp) when the enter key is pressed.
  $("#chirp_box").keypress(function(event) {
    if(event.which == 13) {
      sendChirp();
    }
  });
  
  // ## generateChirp
  // 
  // **Params**  
  // &nbsp;&nbsp;**chirp** Text of the chirp
  // **Returns**  
  // &nbsp;&nbsp;*String* HTML string containing the new chirp, to be appended to the view.

  function generateChirp(chirp) {
    html = "<br /><span><span class=\"identifier\">" + "<%= name %>" + "</span> <a href=\"/<%= username %>\">@";
    html += "<%= username %></a> " + new Date(Date.now()).toString().slice(0, -18) + "</span>";
    html += "<div class=\"chirper\">";
    html += "<p>" + chirp + "</p>";
    html += "</div>";

    return html;
  }
  
  // ## addChirpToView
  // Adds the text of a chirp (generated by generateChirp) to the part of the view which displays chirps.  
  function addChirpToView(chirp) {
    var chirpView = $("#chirp_view");

    chirpView.prepend(generateChirp(chirp));

    if (chirp.toLowerCase() == "I have friends!".toLowerCase()) {
      FireworkDisplay.launchText();
    }
  }

  socket.on('updateView', function (data) {
    addChirpToView(data["chirp"]);
  });
</script>

<% include footer %>